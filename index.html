<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品搜尋</title>
    <link rel="manifest" href="manifest.json">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>

    <h1>商品搜尋</h1>
    
    <input type="text" id="searchInput" placeholder="輸入商品名稱或編號">
    <button onclick="search()">搜尋</button>
    
    <div id="results"></div>

    <script>
        // 解除舊版 Service Worker，並註冊新的 Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then((registrations) => {
                registrations.forEach((registration) => {
                    if (registration.scope === 'https://david-1020.github.io/') {
                        registration.unregister().then(() => {
                            console.log('舊版 Service Worker 已解除註冊');
                        });
                    }
                });
            }).then(() => {
                // 註冊新的 Service Worker 並限制範圍在 /json1015/
                navigator.serviceWorker.register('/json1015/service-worker.js', { scope: '/json1015/' })
                    .then((registration) => {
                        console.log('新的 Service Worker 已註冊，範圍: /json1015/');
                    })
                    .catch((err) => console.log('Service Worker 註冊失敗', err));
            });
        }

        // 搜尋功能
        function search() {
            const query = document.getElementById("searchInput").value.toLowerCase();
            const jsonFilePath = 'latest.json'; // 固定 JSON 檔案名稱

            fetch(jsonFilePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`無法讀取 JSON 檔案: ${jsonFilePath}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const filteredResults = data.filter(item => 
                        (item["商品名稱"] && item["商品名稱"].toLowerCase().includes(query)) || 
                        (item["商品編號"] && item["商品編號"].includes(query))
                    );
                    displayResults(filteredResults);
                })
                .catch(error => {
                    document.getElementById("results").innerHTML = `<p>${error.message}</p>`;
                });
        }

        // 將搜尋結果顯示為表格
        function displayResults(results) {
            if (results.length === 0) {
                document.getElementById("results").innerHTML = "<p>找不到符合條件的商品。</p>";
                return;
            }

            let table = "<table><tr><th>商品編號</th><th>商品名稱</th><th>電腦現存量</th></tr>";
            results.forEach(item => {
                table += `<tr><td>${item["商品編號"]}</td><td>${item["商品名稱"]}</td><td>${item["電腦現存量"]}</td></tr>`;
            });
            table += "</table>";

            document.getElementById("results").innerHTML = table;
        }
    </script>

</body>
</html>
